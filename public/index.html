<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp Gateway Webhook Tester</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <style>
    body {
      padding-top: 20px;
      background-color: #f8f9fa;
    }
    .webhook-card {
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      transition: transform 0.2s;
    }
    .webhook-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .webhook-card.new {
      animation: highlight 2s ease-out;
    }
    @keyframes highlight {
      0% { background-color: #d1e7dd; }
      100% { background-color: white; }
    }
    pre {
      white-space: pre-wrap;
      word-break: break-word;
    }
    .code-block {
      background-color: #f8f9fa;
      border-radius: 5px;
      padding: 10px;
    }
    .navbar {
      margin-bottom: 20px;
    }
    .webhook-info {
      font-size: 0.9rem;
    }
    .message-text {
      font-size: 1.1rem;
      font-weight: 500;
    }
    .timestamp {
      color: #6c757d;
      font-size: 0.85rem;
    }
    .badge-message {
      background-color: #0d6efd;
    }
    .badge-connected {
      background-color: #198754;
    }
    .badge-disconnected {
      background-color: #dc3545;
    }
    .badge-receipt {
      background-color: #6c757d;
    }
    .no-webhooks {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      text-align: center;
      color: #6c757d;
    }
    .webhook-url {
      font-family: monospace;
      padding: 8px 15px;
      background: #e9ecef;
      border-radius: 5px;
      display: inline-block;
      margin-bottom: 15px;
      user-select: all;
    }
    .webhook-url:hover {
      background: #dee2e6;
      cursor: pointer;
    }
    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      font-size: 10px;
      padding: 3px 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="d-flex align-items-center pb-3 mb-4 border-bottom">
      <i class="bi bi-chat-dots-fill me-2 text-success" style="font-size: 2rem;"></i>
      <span class="fs-4">WhatsApp Gateway Webhook Tester</span>
    </header>

    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Webhook Information</h5>
      </div>
      <div class="card-body">
        <p>Use this URL for your WhatsApp Gateway webhook configuration:</p>
        <div class="webhook-url" id="webhook-url" onclick="copyWebhookUrl()"></div>
        <div class="alert alert-success d-none" id="copy-success">
          Webhook URL copied to clipboard!
        </div>
        <p>You will see all incoming webhook events below in real-time.</p>
        <div class="d-flex justify-content-between">
          <div>
            <span class="badge bg-secondary" id="total-count">0 Events</span>
            <span class="badge bg-primary" id="message-count">0 Messages</span>
            <span class="badge bg-success" id="connected-count">0 Connections</span>
            <span class="badge bg-danger" id="disconnected-count">0 Disconnections</span>
            <span class="badge bg-info" id="receipt-count">0 Receipts</span>
          </div>
          <button class="btn btn-sm btn-danger" id="clear-button">
            <i class="bi bi-trash"></i> Clear All
          </button>
        </div>
      </div>
    </div>

    <div id="webhooks-container">
      <div class="no-webhooks" id="no-webhooks">
        <i class="bi bi-hourglass mb-3" style="font-size: 3rem;"></i>
        <h5>Waiting for webhook events...</h5>
        <p>No events received yet. Configure your WhatsApp Gateway to send webhooks to this URL.</p>
      </div>
    </div>
  </div>

  <div class="modal fade" id="json-modal" tabindex="-1" aria-labelledby="json-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="json-modal-label">Webhook Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <pre><code id="json-content"></code></pre>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" id="copy-json-btn">Copy JSON</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    // Connect to Socket.io
    const socket = io();
    let webhooks = [];
    
    // Counter object for event types
    const counters = {
      total: 0,
      message: 0,
      connected: 0,
      disconnected: 0,
      receipt: 0
    };
    
    // Update all counters
    function updateCounters() {
      $('#total-count').text(`${counters.total} Events`);
      $('#message-count').text(`${counters.message} Messages`);
      $('#connected-count').text(`${counters.connected} Connections`);
      $('#disconnected-count').text(`${counters.disconnected} Disconnections`);
      $('#receipt-count').text(`${counters.receipt} Receipts`);
    }
    
    // Get webhook URL
    function getWebhookUrl() {
      const location = window.location;
      return `${location.protocol}//${location.host}/webhook`;
    }
    
    // Copy webhook URL to clipboard
    function copyWebhookUrl() {
      const webhookUrl = getWebhookUrl();
      navigator.clipboard.writeText(webhookUrl).then(() => {
        $('#copy-success').removeClass('d-none');
        setTimeout(() => {
          $('#copy-success').addClass('d-none');
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy: ', err);
      });
    }
    
    // Format timestamp
    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString();
    }
    
    // Get event type badge
    function getEventTypeBadge(eventType) {
      switch (eventType) {
        case 'message':
          return '<span class="badge badge-message">Message</span>';
        case 'connected':
          return '<span class="badge badge-connected">Connected</span>';
        case 'disconnected':
          return '<span class="badge badge-disconnected">Disconnected</span>';
        case 'receipt':
          return '<span class="badge badge-receipt">Receipt</span>';
        default:
          return `<span class="badge bg-secondary">${eventType}</span>`;
      }
    }
    
    // Render webhook card
    function renderWebhookCard(webhook, isNew = false) {
      const payload = webhook.payload;
      const eventType = payload.event_type || 'unknown';
      const clientId = payload.client_id || 'unknown';
      const timestamp = formatTimestamp(webhook.timestamp);
      const badge = getEventTypeBadge(eventType);
      
      let content = '';
      
      // Different content based on event type
      if (eventType === 'message') {
        const message = payload.message || {};
        const from = message.from || 'unknown';
        const senderName = message.sender_name || from;
        const text = message.text || '';
        
        content = `
          <div class="d-flex align-items-center mb-2">
            <i class="bi bi-person-circle me-2" style="font-size: 2rem;"></i>
            <div>
              <div class="fw-bold">${senderName}</div>
              <small class="text-muted">${from}</small>
            </div>
          </div>
          <div class="message-text mb-2">${text}</div>
          ${message.has_media ? '<p><i class="bi bi-card-image"></i> Contains media</p>' : ''}
        `;
      } else if (eventType === 'connected') {
        content = `
          <div class="d-flex align-items-center mb-2">
            <i class="bi bi-wifi me-2 text-success" style="font-size: 1.5rem;"></i>
            <div class="message-text">WhatsApp client connected</div>
          </div>
        `;
      } else if (eventType === 'disconnected') {
        content = `
          <div class="d-flex align-items-center mb-2">
            <i class="bi bi-wifi-off me-2 text-danger" style="font-size: 1.5rem;"></i>
            <div class="message-text">WhatsApp client disconnected</div>
          </div>
        `;
      } else if (eventType === 'receipt') {
        const receipt = payload.receipt || {};
        const type = receipt.type || 'unknown';
        const sender = receipt.sender || 'unknown';
        
        content = `
          <div class="d-flex align-items-center mb-2">
            <i class="bi bi-check-all me-2 text-primary" style="font-size: 1.5rem;"></i>
            <div class="message-text">Receipt: ${type}</div>
          </div>
          <p>From: ${sender}</p>
        `;
      } else {
        content = `
          <div class="d-flex align-items-center mb-2">
            <i class="bi bi-activity me-2" style="font-size: 1.5rem;"></i>
            <div class="message-text">Unknown event type: ${eventType}</div>
          </div>
        `;
      }
      
      let card = `
        <div class="card webhook-card ${isNew ? 'new' : ''}">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div>
              ${badge}
              <small class="ms-2">Client: ${clientId}</small>
            </div>
            <button class="btn btn-sm btn-outline-primary view-json-btn" data-index="${webhooks.indexOf(webhook)}">
              View JSON
            </button>
          </div>
          <div class="card-body">
            ${content}
            <small class="timestamp"><i class="bi bi-clock"></i> ${timestamp}</small>
          </div>
        </div>
      `;
      
      return card;
    }
    
    // Render all webhooks
    function renderWebhooks() {
      if (webhooks.length === 0) {
        $('#no-webhooks').show();
        $('#webhooks-container').html($('#no-webhooks'));
      } else {
        $('#no-webhooks').hide();
        const cardsHtml = webhooks.map(webhook => renderWebhookCard(webhook)).join('');
        $('#webhooks-container').html(cardsHtml);
        
        // Attach event listeners to JSON buttons
        attachJsonViewHandlers();
      }
    }
    
    // Attach event handlers to JSON view buttons
    function attachJsonViewHandlers() {
      $('.view-json-btn').on('click', function() {
        const index = $(this).data('index');
        const webhook = webhooks[index];
        const jsonStr = JSON.stringify(webhook, null, 2);
        $('#json-content').text(jsonStr);
        new bootstrap.Modal(document.getElementById('json-modal')).show();
      });
    }
    
    // When page loads
    $(document).ready(function() {
      // Set webhook URL
      $('#webhook-url').text(getWebhookUrl());
      
      // Initialize empty webhooks container
      renderWebhooks();
      
      // Copy JSON button
      $('#copy-json-btn').on('click', function() {
        const json = $('#json-content').text();
        navigator.clipboard.writeText(json).then(() => {
          const originalText = $(this).text();
          $(this).text('Copied!');
          setTimeout(() => {
            $(this).text(originalText);
          }, 2000);
        }).catch(err => {
          console.error('Failed to copy: ', err);
        });
      });
      
      // Clear button
      $('#clear-button').on('click', function() {
        if (confirm('Are you sure you want to clear all webhook events?')) {
          socket.emit('clear-webhooks');
        }
      });
    });
    
    // Socket.io event handlers
    socket.on('init-webhooks', (initialWebhooks) => {
      webhooks = initialWebhooks;
      
      // Reset counters
      counters.total = webhooks.length;
      counters.message = webhooks.filter(w => w.payload.event_type === 'message').length;
      counters.connected = webhooks.filter(w => w.payload.event_type === 'connected').length;
      counters.disconnected = webhooks.filter(w => w.payload.event_type === 'disconnected').length;
      counters.receipt = webhooks.filter(w => w.payload.event_type === 'receipt').length;
      
      updateCounters();
      renderWebhooks();
    });
    
    socket.on('new-webhook', (webhook) => {
      webhooks.unshift(webhook);
      
      // Update counters
      counters.total++;
      if (webhook.payload.event_type === 'message') counters.message++;
      if (webhook.payload.event_type === 'connected') counters.connected++;
      if (webhook.payload.event_type === 'disconnected') counters.disconnected++;
      if (webhook.payload.event_type === 'receipt') counters.receipt++;
      
      updateCounters();
      
      // Add new webhook card at the top with animation
      if (webhooks.length === 1) {
        renderWebhooks();
      } else {
        $('#no-webhooks').hide();
        const newCard = renderWebhookCard(webhook, true);
        $('#webhooks-container').prepend(newCard);
        attachJsonViewHandlers();
      }
      
      // Add notification sound
      const audio = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=');
      audio.play().catch(() => {});
    });
    
    socket.on('webhooks-cleared', () => {
      webhooks = [];
      
      // Reset counters
      counters.total = 0;
      counters.message = 0;
      counters.connected = 0;
      counters.disconnected = 0;
      counters.receipt = 0;
      
      updateCounters();
      renderWebhooks();
    });
  </script>
</body>
</html>
